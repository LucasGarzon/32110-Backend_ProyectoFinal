<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
  <title>Proyecto Final | Dashboard</title>
</head>
<body>
  <% if (user.isAdmin === true) { %>
  <h1>Bienvenido <%= user.first_name %> <%= user.last_name %> | Administrador</h1>
  <h5><a href="/config">Configuración del servidor</a></h2>
  <h5><a href="/chat">Canal de Chat</a></h5>
  <h2>Productos:</h2>
  <% products.forEach(product => { %>
    <div style="border: 2px solid #000000;" >
      <p>Imagen: <%= product.thumbnail %><p>
      <ul style="list-style: none;">
        <li>Producto: <%= product.title %></li> 
        <li>Precio: $<%= product.price %></li>
        <% if (product.stock === 0) { %>
        <li>Stock: <span style="color: red;">SIN STOCK</span></li>
        <% } else {%>
          <li>Stock: <%= product.stock %></li>
        <% } %>
        <% if (product.category === 1) { %>
          <li>Categoría: Café de especialidad</li>
        <% } else if (product.category === 2) { %>
          <li>Categoría: Brebaje</li>
        <% } %>
      </ul>
      <% if (message === 1) { %>
        <p style="color: red">Superaste la cantidad en stock!</p>
      <% } %>
      <li><a href="/productos/<%= product._id %>">Actualizar producto</a></li>
    </div>
    <br>
  <% }) %>
  <br>
  <div style="border: 2px solid #000000;">
    <h2>Ingresar un nuevo producto</h2>
    <form action="/productos" method="post">
      <label for="name">Titulo:</label>
      <input type="text" name="title" required>
      <br>
      <br>
      <label for="price">precio:</label>
      <input type="number" name="price" required>
      <br>
      <br>
      <label for="stock">Stock:</label>
      <input type="number" name="stock" required>
      <br>
      <br>
      <label for="category">Categoría</label>
      <select name="category" required>
        <option value="1">Café de especialidad</option>
        <option value="2">Brebaje</option>
      </select>
      <br>
      <br>
      <label for="thumbnail">URL de la imagen:</label>
      <input type="text" name="thumbnail" required>
      <br>
      <br>
      <label for="description">Descripción:</label>
      <input type="textarea" name="description" required>
      <br>
      <br>
      <button type="submit">Crear</button>
    </form>
    <br>
  </div>
  <% } else if (user.isAdmin === false) { %> 
    <h1>Bienvenido <%= user.first_name %> <%= user.last_name %></h1>
    <h5>Dirección de entrega: <%= user.address %></h2>
    <h5><a href="/chat">Canal de Chat</a></h5>
    <% products.forEach(product => { %>
      <div style="border: 2px solid #000000;" >
        <p>Imagen: <%= product.thumbnail %><p>
        <ul style="list-style: none;">
          <li>Producto: <%= product.title %></li> 
          <li>Precio: $<%= product.price %></li>
          <% if (product.stock === 0) { %>
          <li>Stock: <span style="color: red;">SIN STOCK</span></li>
          <% } else {%>
            <li>Stock: <%= product.stock %></li>
          <% } %>
          <% if (product.category === 1) { %>
            <li>Categoría: Café de especialidad</li>
          <% } else if (product.category === 2) { %>
            <li>Categoría: Brebaje</li>
          <% } %>
        </ul>
        <form action="/carrito" method="post">
          <input type="hidden" name="userEmail" value=<%= user.email %>>
          <input type="hidden" name="productId" value=<%= product._id %>>
          <button type="submit">Añadir al carrito</button>
        </form>
        <% if (message === 1) { %>
          <p style="color: red">Superaste la cantidad en stock!</p>
        <% } %>
        <li><a href="/productos/<%= product._id %>">Detalles del producto</a></li>
      </div>
      <br>
    <% }) %>
    <a href="/carrito/<%= user.email %>">Carrito</a>
    <br>
  <% } %> 
  <a href="/logout">Cerar sesión</a> 
  <br>
  <br>
  <form id="delete-user-form">
    <button type="button" id="delete-user-button" style="background-color: red; color: white;">Eliminar cuenta</button>
  </form>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
  <script>
    const userId = "<%= user.id %>";
    const deleteUserForm = document.getElementById("delete-user-form");
    const deleteUserBtn = document.getElementById("delete-user-button");

    deleteUserBtn.addEventListener("click", async () => {
      try {
        const response = await fetch(`/${userId}`, { method: "DELETE" });
        if (response.ok) {
          window.location.reload()
        } else {
          console.error(`Delete user failed: ${response.statusText}`)
        }
      } catch (error) {
        console.error(`Delete user failed: ${error}`)
      }
    });
  </script>
</body>
</html>